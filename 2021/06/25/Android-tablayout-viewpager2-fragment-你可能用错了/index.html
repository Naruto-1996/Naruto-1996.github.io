<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Android tablayout viewpager2 fragment 你可能用错了 | Weaver Li</title>
  <meta name="author" content="Weaver Li">
  
  <meta name="description" content="Time is money!">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Android tablayout viewpager2 fragment 你可能用错了"/>
  <meta property="og:site_name" content="Weaver Li"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="Weaver Li" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-70812759-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-70812759-1');
</script>






<meta name="generator" content="Hexo 7.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Weaver Li</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Android tablayout viewpager2 fragment 你可能用错了</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <h3 id="tabLayout-viewPager2-fragment-用不好会导致内存泄漏"><a href="#tabLayout-viewPager2-fragment-用不好会导致内存泄漏" class="headerlink" title="tabLayout + viewPager2 + fragment 用不好会导致内存泄漏"></a>tabLayout + viewPager2 + fragment 用不好会导致内存泄漏</h3><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>tabLayout + viewPager2 + fragment 这是在app开发中非常常见的UI架构了 但是用不好的话 是会导致内存泄漏的</p>
<p><a href="https://github.com/Naruto-1996/ViewPager2_Demo">Demo地址</a></p>
<p>先上图: </p>
<p>(<code>app</code>模板使用<code>android studio</code> 创建一个就行 我只用 <code>HomeFragment</code>)</p>
<img src="https://ae03.alicdn.com/kf/U3292cb58c99d44a3bcf092f9d0fba361h.png" width = "300" height = "600" alt="图片名称" align=center />

<h3 id="先了解一下viewPager"><a href="#先了解一下viewPager" class="headerlink" title="先了解一下viewPager"></a>先了解一下viewPager</h3><p>之前我们都是使用viewPager 但是 viewPager 有两个毛病 </p>
<ul>
<li><p>不能关闭预加载</p>
</li>
<li><p>更新Adapter不生效</p>
</li>
</ul>
<p>虽然能解决 但是很麻烦</p>
<p>viewPager 有个方法 <code>offscreenPageLimit</code> 用来设置 当前页前后预加载的数量 即使设置为0也不起任何作用 因为源码中默认值为1</p>
<p>先来看个图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/Naruto-1996/picture/images/20210625175636.png"></p>
<p>上面是<code>ViewPager</code>默认情况下的加载示意图，当切换到当前页面时，会默认预加载左右两侧的布局到<code>ViewPager</code>中，<br>尽管两侧的<code>View</code>并不可见的，我们称这种情况叫预加载；由于<code>ViewPager</code>对<code>offscreenPageLimit</code>设置了限制，<br>页面的预加载是不可避免</p>
<p>如果使用 一定要使用viewPager 也可以做到 fragment 懒加载 主要是对<code>fragment</code>做手脚 结合生命周期方法和setUserVisibleHint状态，控制数据延迟加载，而布局只能提前进入</p>
<h3 id="viewPager2基本使用"><a href="#viewPager2基本使用" class="headerlink" title="viewPager2基本使用"></a>viewPager2基本使用</h3><p>1、 承载tabLayout 和 viewPager2 需要一个 fragment 或者 activity 这里我们使用 fragment</p>
<p><code>HomeFragment</code> 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> HomeViewModel homeViewModel;</span><br><span class="line">  <span class="keyword">private</span> TabLayout tabLayout;</span><br><span class="line">  <span class="keyword">private</span> ViewPager2 viewPager2;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ArrayList&lt;String&gt; tabTitles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用List 存放fragment 不推荐使用 用不好 导致内存泄漏</span></span><br><span class="line">  <span class="keyword">private</span> ArrayList&lt;BlankFragment&gt; fragments = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(<span class="meta">@NonNull</span> LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    homeViewModel = <span class="keyword">new</span> <span class="title class_">ViewModelProvider</span>(<span class="built_in">this</span>).get(HomeViewModel.class);</span><br><span class="line">    <span class="type">View</span> <span class="variable">root</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_home, container, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    tabLayout = root.findViewById(R.id.tabs);</span><br><span class="line">    viewPager2 = root.findViewById(R.id.viewPager);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onViewCreated</span><span class="params">(<span class="meta">@NonNull</span> View view, <span class="meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onViewCreated(view, savedInstanceState);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化 tabTitles 和 fragments</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">15</span>; i++) &#123;</span><br><span class="line">      tabTitles.add(String.valueOf(i));</span><br><span class="line">      fragments.add(BlankFragment.newInstance(tabTitles.get(i)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭预加载</span></span><br><span class="line">    viewPager2.setOffscreenPageLimit(ViewPager2.OFFSCREEN_PAGE_LIMIT_DEFAULT);  <span class="comment">// 可以不设置 因为默认是 -1 默认不进行预加载</span></span><br><span class="line">    <span class="comment">// 这个必须设置 不然仍然会启用预加载</span></span><br><span class="line">    ((RecyclerView)viewPager2.getChildAt(<span class="number">0</span>)).getLayoutManager().setItemPrefetchEnabled(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 设置缓存数量，对应 RecyclerView 中的 mCachedViews，即屏幕外的视图数量</span></span><br><span class="line">    ((RecyclerView)viewPager2.getChildAt(<span class="number">0</span>)).setItemViewCacheSize(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一种方法 (可能会内存泄漏)</span></span><br><span class="line">    <span class="comment">//FragmentAdapter adapter = new FragmentAdapter(this, fragments);</span></span><br><span class="line">    <span class="comment">//viewPager2.setAdapter(adapter);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里使用第二种方法</span></span><br><span class="line">    viewPager2.setAdapter(<span class="keyword">new</span> <span class="title class_">FragmentStateAdapter</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">      <span class="meta">@NonNull</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> Fragment <span class="title function_">createFragment</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BlankFragment.newInstance(tabTitles.get(position));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemCount</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tabTitles.size();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// viewPager2 滑动监听</span></span><br><span class="line">    viewPager2.registerOnPageChangeCallback(<span class="keyword">new</span> <span class="title class_">ViewPager2</span>.OnPageChangeCallback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageSelected</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onPageSelected(position);</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里第四个参数一定要设置为false  如果设置为true时 我们在滑动时 BlankFragment的创建 和 销毁 都很正常</span></span><br><span class="line">    <span class="comment">// 一旦 我们通过 点击tabLayout时 如果两个tab距离过远  那么所有划过的tabLayout 都会创建和销毁BlankFragment 这显然不是我们想要的</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// tabLayout 和 viewPager 联动</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">TabLayoutMediator</span>(tabLayout, viewPager2,<span class="literal">true</span>,<span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">TabLayoutMediator</span>.TabConfigurationStrategy() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigureTab</span><span class="params">(<span class="meta">@NonNull</span> TabLayout.Tab tab, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">        tab.setText(tabTitles.get(position));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).attach();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>fragment_home.xml</code> 布局文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">tools:context</span>=<span class="string">&quot;.ui.home.HomeFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">com.google.android.material.tabs.TabLayout</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/tabs&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;40dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabGravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabIndicatorColor</span>=<span class="string">&quot;#ff678f&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabIndicatorFullWidth</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabIndicatorHeight</span>=<span class="string">&quot;2dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabMode</span>=<span class="string">&quot;scrollable&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabSelectedTextColor</span>=<span class="string">&quot;#ff678f&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabTextColor</span>=<span class="string">&quot;#333333&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:tabUnboundedRipple</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">androidx.viewpager2.widget.ViewPager2</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/viewPager&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@color/purple_200&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_weight</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2、viewPager2的 FragmentStateAdapter 创建fragment时 我们 复用一个fragment</p>
<p><code>BlankFragment</code> 如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlankFragment</span> <span class="keyword">extends</span> <span class="title class_">Fragment</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String mParam1;</span><br><span class="line">  <span class="keyword">private</span> TextView mTextView;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> BlankFragment <span class="title function_">newInstance</span><span class="params">(String param1)</span> &#123;</span><br><span class="line">    <span class="type">BlankFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlankFragment</span>();</span><br><span class="line">    <span class="type">Bundle</span> <span class="variable">args</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line">    args.putString(<span class="string">&quot;param1&quot;</span>, param1);</span><br><span class="line">    fragment.setArguments(args);</span><br><span class="line">    <span class="keyword">return</span> fragment;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPause</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onPause();</span><br><span class="line">    Log.i(<span class="string">&quot;TAG=======onPause&quot;</span>, mParam1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="keyword">if</span> (getArguments() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mParam1 = getArguments().getString(<span class="string">&quot;param1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Log.i(<span class="string">&quot;TAG=======onCreate&quot;</span>, mParam1);</span><br><span class="line">    Toast.makeText(getContext(), mParam1, Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">    Log.i(<span class="string">&quot;TAG=======onDestroy&quot;</span>, mParam1);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> View <span class="title function_">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="comment">// Inflate the layout for this fragment</span></span><br><span class="line">    <span class="type">View</span> <span class="variable">root</span> <span class="operator">=</span> inflater.inflate(R.layout.fragment_blank, container, <span class="literal">false</span>);</span><br><span class="line">    mTextView = root.findViewById(R.id.text1);</span><br><span class="line">    mTextView.setText(mParam1);</span><br><span class="line">    Log.i(<span class="string">&quot;TAG=======onCreateView&quot;</span>, mParam1);</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对外提供一个刷新Ui的方法</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refreshUi</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (getArguments() != <span class="literal">null</span>) &#123;</span><br><span class="line">      mParam1 = getArguments().getString(<span class="string">&quot;param1&quot;</span>);</span><br><span class="line">      mTextView.setText(mParam1 + <span class="string">&quot;ddd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroyView</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDestroyView();</span><br><span class="line">    Log.i(<span class="string">&quot;TAG======onDestroyView&quot;</span>, mParam1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>fragment_blank.xml</code> 如下:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">tools:context</span>=<span class="string">&quot;.ui.BlankFragment&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/text1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:textSize</span>=<span class="string">&quot;26sp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:text</span>=<span class="string">&quot;black&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>至此 我们已经完成了 tabLayout + viewPager2 + fragment </p>
<h3 id="viewPager2常用方法"><a href="#viewPager2常用方法" class="headerlink" title="viewPager2常用方法"></a>viewPager2常用方法</h3><ul>
<li><code>setAdapter()</code> 设置适配器</li>
<li><code>setOrientation()</code> 设置布局方向</li>
<li><code>setCurrentItem()</code> 设置当前Item下标</li>
<li><code>beginFakeDrag()</code> 开始模拟拖拽</li>
<li><code>fakeDragBy()</code> 模拟拖拽中</li>
<li><code>endFakeDrag()</code> 模拟拖拽结束</li>
<li><code>setUserInputEnabled()</code> 设置是否允许用户输入&#x2F;触摸</li>
<li><code>setOffscreenPageLimit()</code> 设置屏幕外加载页面数量</li>
<li><code>registerOnPageChangeCallback()</code> 注册页面滑动监听回调</li>
<li><code>setPageTransformer()</code> 设置页面滑动时的变换效果</li>
</ul>
<h3 id="ViewPager2-预加载和缓存"><a href="#ViewPager2-预加载和缓存" class="headerlink" title="ViewPager2 预加载和缓存"></a>ViewPager2 预加载和缓存</h3><p><code>viewPager2</code> 是存在预加载和缓存的 我们虽然可以通过<code>offscreenPageLimit</code> 去设置预加载的数量 但是 <code>viewPager2</code> 会默认帮我们<br>缓存两个<code>fragment</code> 意思就是我们再滑动回来时 不会再去走 fragment 创建的生命周期了 会走 onResume 生命周期函数</p>
<p><code>one picture is worth a thousand words</code> :</p>
<p><code>viewPager2</code> 默认开启预加载 </p>
<p><img src="https://cdn.jsdelivr.net/gh/Naruto-1996/picture/images/20210625182426.png"></p>
<p><strong>如何关闭预加载、并设置缓存数量</strong></p>
<p><strong>常见设置如下</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//设置应保留在当前可见页面两侧的页面数</span></span><br><span class="line">viewPager2.setOffscreenPageLimit(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭预加载</span></span><br><span class="line">((RecyclerView)viewPager2.getChildAt(<span class="number">0</span>)).getLayoutManager().setItemPrefetchEnabled(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置缓存数量，对应 RecyclerView 中的 mCachedViews，即屏幕外的视图数量</span></span><br><span class="line">((RecyclerView)viewPager2.getChildAt(<span class="number">0</span>)).setItemViewCacheSize(<span class="number">4</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>viewPager2</code> 会默认缓存2个<code>ItemView</code></p>
<p>我们将<code>((RecyclerView)viewPager2.getChildAt(0)).setItemViewCacheSize(0);</code> 设置为<code>0</code>即可 这样我们每次滑动一个新的<code>tab</code>时 会创建<br>新的<code>fragment</code>并销毁上一个<code>fragment</code></p>
<h3 id="viewPager2-对-fragment-的支持"><a href="#viewPager2-对-fragment-的支持" class="headerlink" title="viewPager2 对 fragment 的支持"></a>viewPager2 对 fragment 的支持</h3><p>目前，<code>ViewPager2</code>对<code>Fragment</code>的支持只能使用<code>FragmentStateAdapter</code>，使用起来也是非常简单：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">viewPager2.setAdapter(<span class="keyword">new</span> <span class="title class_">FragmentStateAdapter</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">  <span class="meta">@NonNull</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Fragment <span class="title function_">createFragment</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> BlankFragment.newInstance(tabTitles.get(position));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getItemCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tabTitles.size();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="另外还有一个小坑"><a href="#另外还有一个小坑" class="headerlink" title="另外还有一个小坑"></a>另外还有一个小坑</h3><p><strong>ViewPager2+TabLayout懒加载问题，Fragment被创建多次</strong></p>
<p><code>ViewPager2</code>默认只加载当前页面，相当于官方处理了<code>Fragment</code>的懒加载问题，当你使用代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">new TabLayoutMediator(tabLayout, viewPager, true, new TabLayoutMediator.TabConfigurationStrategy() &#123;</span><br><span class="line"></span><br><span class="line">       @Override</span><br><span class="line"></span><br><span class="line">       public void onConfigureTab(@NonNull TabLayout.Tab tab, int position) &#123;</span><br><span class="line"></span><br><span class="line">           tab.setText(titles.get(position));</span><br><span class="line"></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;).attach();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时当你滑动<code>ViewPager2</code>时，滑动到某个<code>Fragment</code>页面才会加载，执行onCreateView()方法，</p>
<p>但是当你手动点击<code>TabLayout</code>时，此时懒加载就会失效，<code>onCreateView()</code>会被执行多次，</p>
<p>原因就是…此时<code>ViewPager2</code>默认是平滑滚动的，滚动滑过的<code>Fragment</code>都会被加载，</p>
<p><strong>只需修改代码:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">TabLayoutMediator</span>(tabLayout, viewPager, <span class="literal">true</span>,<span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">TabLayoutMediator</span>.TabConfigurationStrategy() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigureTab</span><span class="params">(<span class="meta">@NonNull</span> TabLayout.Tab tab, <span class="type">int</span> position)</span> &#123;</span><br><span class="line"></span><br><span class="line">                tab.setText(titles.get(position));</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#125;).attach();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中，第二个<code>boolean</code>参数为<code>smoothScroll</code> 一定要填<code>false</code>  这时点击 哪个<code>tab</code> 就会创建 哪个 <code>fragment</code></p>
<p>但是页面看起来没有那么平滑了 各有利弊吧</p>
<p><strong>—————————————————————————————</strong></p>
<p>如果 需要点击tab无动画 滑动页面时有动画 怎么办呢?</p>
<p>TabLayoutMediator 是final类  且smoothScroll字段是私有的、我们没法继承重写、但是可以copy源码修改、不会有问题</p>
<p>我们将 源码copy下来 稍作修改就可以用了 下面是修改好的代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> androidx.viewpager2.widget.ViewPager2.SCROLL_STATE_DRAGGING;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> androidx.viewpager2.widget.ViewPager2.SCROLL_STATE_IDLE;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> androidx.viewpager2.widget.ViewPager2.SCROLL_STATE_SETTLING;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.RecyclerView;</span><br><span class="line"><span class="keyword">import</span> androidx.viewpager2.widget.ViewPager2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.android.material.tabs.TabLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.ref.WeakReference;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A mediator to link a TabLayout with a ViewPager2. The mediator will synchronize the ViewPager2&#x27;s</span></span><br><span class="line"><span class="comment"> * position with the selected tab when a tab is selected, and the TabLayout&#x27;s scroll position when</span></span><br><span class="line"><span class="comment"> * the user drags the ViewPager2. TabLayoutMediator will listen to ViewPager2&#x27;s OnPageChangeCallback</span></span><br><span class="line"><span class="comment"> * to adjust tab when ViewPager2 moves. TabLayoutMediator listens to TabLayout&#x27;s</span></span><br><span class="line"><span class="comment"> * OnTabSelectedListener to adjust VP2 when tab moves. TabLayoutMediator listens to RecyclerView&#x27;s</span></span><br><span class="line"><span class="comment"> * AdapterDataObserver to recreate tab content when dataset changes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;Establish the link by creating an instance of this class, make sure the ViewPager2 has an</span></span><br><span class="line"><span class="comment"> * adapter and then call &#123;<span class="doctag">@link</span> #attach()&#125; on it. Instantiating a TabLayoutMediator will only create</span></span><br><span class="line"><span class="comment"> * the mediator object, &#123;<span class="doctag">@link</span> #attach()&#125; will link the TabLayout and the ViewPager2 together. When</span></span><br><span class="line"><span class="comment"> * creating an instance of this class, you must supply an implementation of &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment"> * com.google.android.material.tabs.TabLayoutMediator.TabConfigurationStrategy&#125; in which you set the text of the tab, and/or perform any styling of the</span></span><br><span class="line"><span class="comment"> * tabs that you require. Changing ViewPager2&#x27;s adapter will require a &#123;<span class="doctag">@link</span> #detach()&#125; followed by</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> #attach()&#125; call. Changing the ViewPager2 or TabLayout will require a new instantiation of</span></span><br><span class="line"><span class="comment"> * TabLayoutMediator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TabLayoutMediators</span> &#123;</span><br><span class="line">  <span class="meta">@NonNull</span> <span class="keyword">private</span> <span class="keyword">final</span> TabLayout tabLayout;</span><br><span class="line">  <span class="meta">@NonNull</span> <span class="keyword">private</span> <span class="keyword">final</span> ViewPager2 viewPager;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> autoRefresh;</span><br><span class="line">  <span class="comment">// 这里我们改为静态变量 以便于在静态方法中使用这个变量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> smoothScroll;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> TabConfigurationStrategy tabConfigurationStrategy;</span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> RecyclerView.Adapter&lt;?&gt; adapter;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> attached;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> TabLayoutOnPageChangeCallback onPageChangeCallback;</span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> TabLayout.OnTabSelectedListener onTabSelectedListener;</span><br><span class="line">  <span class="meta">@Nullable</span> <span class="keyword">private</span> RecyclerView.AdapterDataObserver pagerAdapterObserver;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A callback interface that must be implemented to set the text and styling of newly created</span></span><br><span class="line"><span class="comment">   * tabs.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TabConfigurationStrategy</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Called to configure the tab for the page at the specified position. Typically calls &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     * TabLayout.Tab#setText(CharSequence)&#125;, but any form of styling can be applied.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> tab The Tab which should be configured to represent the title of the item at the given</span></span><br><span class="line"><span class="comment">     *     position in the data set.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> position The position of the item within the adapter&#x27;s data set.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">onConfigureTab</span><span class="params">(<span class="meta">@NonNull</span> TabLayout.Tab tab, <span class="type">int</span> position)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TabLayoutMediators</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabLayout tabLayout,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> ViewPager2 viewPager,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabConfigurationStrategy tabConfigurationStrategy)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(tabLayout, viewPager, <span class="comment">/* autoRefresh= */</span> <span class="literal">true</span>, tabConfigurationStrategy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TabLayoutMediators</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabLayout tabLayout,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> ViewPager2 viewPager,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> autoRefresh,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabConfigurationStrategy tabConfigurationStrategy)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>(tabLayout, viewPager, autoRefresh, <span class="comment">/* smoothScroll= */</span> <span class="literal">true</span>, tabConfigurationStrategy);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">TabLayoutMediators</span><span class="params">(</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabLayout tabLayout,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> ViewPager2 viewPager,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> autoRefresh,</span></span><br><span class="line"><span class="params">    <span class="type">boolean</span> smoothScroll,</span></span><br><span class="line"><span class="params">    <span class="meta">@NonNull</span> TabConfigurationStrategy tabConfigurationStrategy)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.tabLayout = tabLayout;</span><br><span class="line">    <span class="built_in">this</span>.viewPager = viewPager;</span><br><span class="line">    <span class="built_in">this</span>.autoRefresh = autoRefresh;</span><br><span class="line">    TabLayoutMediators.smoothScroll = smoothScroll;</span><br><span class="line">    <span class="built_in">this</span>.tabConfigurationStrategy = tabConfigurationStrategy;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Link the TabLayout and the ViewPager2 together. Must be called after ViewPager2 has an adapter</span></span><br><span class="line"><span class="comment">   * set. To be called on a new instance of TabLayoutMediator or if the ViewPager2&#x27;s adapter</span></span><br><span class="line"><span class="comment">   * changes.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IllegalStateException If the mediator is already attached, or the ViewPager2 has no</span></span><br><span class="line"><span class="comment">   *     adapter.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">attach</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (attached) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;TabLayoutMediator is already attached&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    adapter = viewPager.getAdapter();</span><br><span class="line">    <span class="keyword">if</span> (adapter == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">        <span class="string">&quot;TabLayoutMediator attached before ViewPager2 has an &quot;</span> + <span class="string">&quot;adapter&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    attached = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Add our custom OnPageChangeCallback to the ViewPager</span></span><br><span class="line">    onPageChangeCallback = <span class="keyword">new</span> <span class="title class_">TabLayoutOnPageChangeCallback</span>(tabLayout);</span><br><span class="line">    viewPager.registerOnPageChangeCallback(onPageChangeCallback);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we&#x27;ll add a tab selected listener to set ViewPager&#x27;s current item</span></span><br><span class="line">    onTabSelectedListener = <span class="keyword">new</span> <span class="title class_">ViewPagerOnTabSelectedListener</span>(viewPager, smoothScroll);</span><br><span class="line">    tabLayout.addOnTabSelectedListener(onTabSelectedListener);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we&#x27;ll populate ourselves from the pager adapter, adding an observer if</span></span><br><span class="line">    <span class="comment">// autoRefresh is enabled</span></span><br><span class="line">    <span class="keyword">if</span> (autoRefresh) &#123;</span><br><span class="line">      <span class="comment">// Register our observer on the new adapter</span></span><br><span class="line">      pagerAdapterObserver = <span class="keyword">new</span> <span class="title class_">PagerAdapterObserver</span>();</span><br><span class="line">      adapter.registerAdapterDataObserver(pagerAdapterObserver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    populateTabsFromPagerAdapter();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now update the scroll position to match the ViewPager&#x27;s current item</span></span><br><span class="line">    tabLayout.setScrollPosition(viewPager.getCurrentItem(), <span class="number">0f</span>, <span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Unlink the TabLayout and the ViewPager. To be called on a stale TabLayoutMediator if a new one</span></span><br><span class="line"><span class="comment">   * is instantiated, to prevent holding on to a view that should be garbage collected. Also to be</span></span><br><span class="line"><span class="comment">   * called before &#123;<span class="doctag">@link</span> #attach()&#125; when a ViewPager2&#x27;s adapter is changed.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (autoRefresh &amp;&amp; adapter != <span class="literal">null</span>) &#123;</span><br><span class="line">      adapter.unregisterAdapterDataObserver(pagerAdapterObserver);</span><br><span class="line">      pagerAdapterObserver = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tabLayout.removeOnTabSelectedListener(onTabSelectedListener);</span><br><span class="line">    viewPager.unregisterOnPageChangeCallback(onPageChangeCallback);</span><br><span class="line">    onTabSelectedListener = <span class="literal">null</span>;</span><br><span class="line">    onPageChangeCallback = <span class="literal">null</span>;</span><br><span class="line">    adapter = <span class="literal">null</span>;</span><br><span class="line">    attached = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressWarnings(&quot;WeakerAccess&quot;)</span></span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">populateTabsFromPagerAdapter</span><span class="params">()</span> &#123;</span><br><span class="line">    tabLayout.removeAllTabs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (adapter != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">adapterCount</span> <span class="operator">=</span> adapter.getItemCount();</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; adapterCount; i++) &#123;</span><br><span class="line">        TabLayout.<span class="type">Tab</span> <span class="variable">tab</span> <span class="operator">=</span> tabLayout.newTab();</span><br><span class="line">        tabConfigurationStrategy.onConfigureTab(tab, i);</span><br><span class="line">        tabLayout.addTab(tab, <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Make sure we reflect the currently set ViewPager item</span></span><br><span class="line">      <span class="keyword">if</span> (adapterCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">lastItem</span> <span class="operator">=</span> tabLayout.getTabCount() - <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">currItem</span> <span class="operator">=</span> Math.min(viewPager.getCurrentItem(), lastItem);</span><br><span class="line">        <span class="keyword">if</span> (currItem != tabLayout.getSelectedTabPosition()) &#123;</span><br><span class="line">          tabLayout.selectTab(tabLayout.getTabAt(currItem));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A &#123;<span class="doctag">@link</span> ViewPager2.OnPageChangeCallback&#125; class which contains the necessary calls back to the</span></span><br><span class="line"><span class="comment">   * provided &#123;<span class="doctag">@link</span> TabLayout&#125; so that the tab position is kept in sync.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * &lt;p&gt;This class stores the provided TabLayout weakly, meaning that you can use &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">   * ViewPager2#registerOnPageChangeCallback(ViewPager2.OnPageChangeCallback)&#125; without removing the</span></span><br><span class="line"><span class="comment">   * callback and not cause a leak.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TabLayoutOnPageChangeCallback</span> <span class="keyword">extends</span> <span class="title class_">ViewPager2</span>.OnPageChangeCallback &#123;</span><br><span class="line">    <span class="meta">@NonNull</span> <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;TabLayout&gt; tabLayoutRef;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> previousScrollState;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> scrollState;</span><br><span class="line"></span><br><span class="line">    TabLayoutOnPageChangeCallback(TabLayout tabLayout) &#123;</span><br><span class="line">      tabLayoutRef = <span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;&gt;(tabLayout);</span><br><span class="line">      reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageScrollStateChanged</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> state)</span> &#123;</span><br><span class="line">      <span class="comment">// 根据 是滑动的viewPager还是 点击的 tab 去设置 是否需要平滑动画</span></span><br><span class="line">      <span class="keyword">if</span> (state == SCROLL_STATE_DRAGGING) &#123;</span><br><span class="line">        <span class="comment">// 如果是滑动就设置平滑动画</span></span><br><span class="line">        smoothScroll = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SCROLL_STATE_IDLE) &#123;</span><br><span class="line">        <span class="comment">// 点击的tab就不设置平滑动画</span></span><br><span class="line">        smoothScroll = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      previousScrollState = scrollState;</span><br><span class="line">      scrollState = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageScrolled</span><span class="params">(<span class="type">int</span> position, <span class="type">float</span> positionOffset, <span class="type">int</span> positionOffsetPixels)</span> &#123;</span><br><span class="line">      <span class="type">TabLayout</span> <span class="variable">tabLayout</span> <span class="operator">=</span> tabLayoutRef.get();</span><br><span class="line">      <span class="keyword">if</span> (tabLayout != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// Only update the text selection if we&#x27;re not settling, or we are settling after</span></span><br><span class="line">        <span class="comment">// being dragged</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">updateText</span> <span class="operator">=</span></span><br><span class="line">          scrollState != SCROLL_STATE_SETTLING || previousScrollState == SCROLL_STATE_DRAGGING;</span><br><span class="line">        <span class="comment">// Update the indicator if we&#x27;re not settling after being idle. This is caused</span></span><br><span class="line">        <span class="comment">// from a setCurrentItem() call and will be handled by an animation from</span></span><br><span class="line">        <span class="comment">// onPageSelected() instead.</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">updateIndicator</span> <span class="operator">=</span></span><br><span class="line">          !(scrollState == SCROLL_STATE_SETTLING &amp;&amp; previousScrollState == SCROLL_STATE_IDLE);</span><br><span class="line">        tabLayout.setScrollPosition(position, positionOffset, updateText, updateIndicator);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageSelected</span><span class="params">(<span class="keyword">final</span> <span class="type">int</span> position)</span> &#123;</span><br><span class="line">      <span class="type">TabLayout</span> <span class="variable">tabLayout</span> <span class="operator">=</span> tabLayoutRef.get();</span><br><span class="line">      <span class="keyword">if</span> (tabLayout != <span class="literal">null</span></span><br><span class="line">        &amp;&amp; tabLayout.getSelectedTabPosition() != position</span><br><span class="line">        &amp;&amp; position &lt; tabLayout.getTabCount()) &#123;</span><br><span class="line">        <span class="comment">// Select the tab, only updating the indicator if we&#x27;re not being dragged/settled</span></span><br><span class="line">        <span class="comment">// (since onPageScrolled will handle that).</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">updateIndicator</span> <span class="operator">=</span></span><br><span class="line">          scrollState == SCROLL_STATE_IDLE</span><br><span class="line">            || (scrollState == SCROLL_STATE_SETTLING</span><br><span class="line">            &amp;&amp; previousScrollState == SCROLL_STATE_IDLE);</span><br><span class="line">        tabLayout.selectTab(tabLayout.getTabAt(position), updateIndicator);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">reset</span><span class="params">()</span> &#123;</span><br><span class="line">      previousScrollState = scrollState = SCROLL_STATE_IDLE;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A &#123;<span class="doctag">@link</span> TabLayout.OnTabSelectedListener&#125; class which contains the necessary calls back to the</span></span><br><span class="line"><span class="comment">   * provided &#123;<span class="doctag">@link</span> ViewPager2&#125; so that the tab position is kept in sync.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ViewPagerOnTabSelectedListener</span> <span class="keyword">implements</span> <span class="title class_">TabLayout</span>.OnTabSelectedListener &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ViewPager2 viewPager;</span><br><span class="line">    <span class="comment">// 注释掉这个局部变量 使用最上边的那个全局变量</span></span><br><span class="line">    <span class="comment">//private final boolean smoothScroll;</span></span><br><span class="line"></span><br><span class="line">    ViewPagerOnTabSelectedListener(ViewPager2 viewPager, <span class="type">boolean</span> smoothScroll) &#123;</span><br><span class="line">      <span class="built_in">this</span>.viewPager = viewPager;</span><br><span class="line">      <span class="comment">// 这一行也注释掉</span></span><br><span class="line">      <span class="comment">//this.smoothScroll = smoothScroll;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabSelected</span><span class="params">(<span class="meta">@NonNull</span> TabLayout.Tab tab)</span> &#123;</span><br><span class="line">      viewPager.setCurrentItem(tab.getPosition(), smoothScroll);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabUnselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line">      <span class="comment">// No-op</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabReselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line">      <span class="comment">// No-op</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">PagerAdapterObserver</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span>.AdapterDataObserver &#123;</span><br><span class="line">    PagerAdapterObserver() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onChanged</span><span class="params">()</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemRangeChanged</span><span class="params">(<span class="type">int</span> positionStart, <span class="type">int</span> itemCount)</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemRangeChanged</span><span class="params">(<span class="type">int</span> positionStart, <span class="type">int</span> itemCount, <span class="meta">@Nullable</span> Object payload)</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemRangeInserted</span><span class="params">(<span class="type">int</span> positionStart, <span class="type">int</span> itemCount)</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemRangeRemoved</span><span class="params">(<span class="type">int</span> positionStart, <span class="type">int</span> itemCount)</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemRangeMoved</span><span class="params">(<span class="type">int</span> fromPosition, <span class="type">int</span> toPosition, <span class="type">int</span> itemCount)</span> &#123;</span><br><span class="line">      populateTabsFromPagerAdapter();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>具体用法为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">TabLayoutMediators</span>(tabLayout, viewPager2, <span class="keyword">new</span> <span class="title class_">TabLayoutMediators</span>.TabConfigurationStrategy() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onConfigureTab</span><span class="params">(<span class="meta">@NonNull</span> TabLayout.Tab tab, <span class="type">int</span> position)</span> &#123;</span><br><span class="line">    tab.setText(tabTitles.get(position));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;).attach();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>和官方的用法一样 没啥差别</p>
<p><strong>—————————————————————————————</strong></p>
<p>如果即要求点击tab有动画 滑动页面也有动画 可以看下面这个 我们摒弃官方的 TabLayoutMediator 联动方法</p>
<p>我们自己来手动 让 tabLayout 和 viewPager2 联动起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">firstMethod</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 tabLayout 标题</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tabTitles.size(); i++) &#123;</span><br><span class="line">      tabLayout.addTab(tabLayout.newTab().setText(tabTitles.get(i)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 监听tabLayout事件 设置选中的viewPager2</span></span><br><span class="line">    tabLayout.addOnTabSelectedListener(<span class="keyword">new</span> <span class="title class_">TabLayout</span>.OnTabSelectedListener() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabSelected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line">        viewPager2.setCurrentItem(tab.getPosition(), <span class="literal">false</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabUnselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTabReselected</span><span class="params">(TabLayout.Tab tab)</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// viewPager2 滑动监听 设置tab选中</span></span><br><span class="line">    viewPager2.registerOnPageChangeCallback(<span class="keyword">new</span> <span class="title class_">ViewPager2</span>.OnPageChangeCallback() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPageSelected</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">        tabLayout.selectTab(tabLayout.getTabAt(position));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>viewPager2的优点还是有目共睹的, 但是还是要去踩坑啊，我之前也是用<code>viewPager2</code> 但是没用对的话是会产生内存泄露的<br>所以就研究了一下 在这里记录一下问题 参考了很多博客 基本上都不咋解决问题</p>
<p>只有下面这四篇有帮助 感谢!!!</p>
<p>第一篇、 <a target="_blank" rel="noopener" href="https://hitendev.github.io/2019/05/14/ViewPager2%E9%87%8D%E5%A4%A7%E6%9B%B4%E6%96%B0%EF%BC%8C%E6%94%AF%E6%8C%81offscreenPageLimit/">ViewPager2重大更新</a></p>
<p>第二篇、 <a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904114124652558#heading-9">ViewPager2主要功能</a></p>
<p>第三篇、 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/2cc7bdd50c6c">解决ViewPager2+TabLayout懒加载问题，Fragment被创建多次</a></p>
<p>第四篇、<a target="_blank" rel="noopener" href="https://blog.csdn.net/BirdEatBug/article/details/117414954">android ViewPager2+TabLayout、滑动效果相关问题！</a></p>
<p><strong>另外</strong></p>
<p>LeakCanary –&gt; <a target="_blank" rel="noopener" href="https://square.github.io/leakcanary/getting_started/">内存泄漏检测工具</a></p>
<p>使用非常简单 </p>
<p>只需要 在build.gradle 中 添加这么一行就可以了 只会在debug模式下检测 不会影响到 正式环境</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">  // debugImplementation because LeakCanary should only run in debug builds.</span><br><span class="line">  debugImplementation &#x27;com.squareup.leakcanary:leakcanary-android:2.7&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

	  <div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议(CC BY-NC-SA 4.0) 发布.</a>
</div>

	</div>

	
	
	<div>
  	<center>

	<div class="pagination">

    
    
    <a href="/2021/07/01/记一次被钓鱼网站盗走eth的经历/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2021/06/22/Android-中的单例模式/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


    </center>
	</div>
	
	<!-- comment -->
	<!--
<section id="comment">
    <h2 class="title">留言</h2>

    
</section>

-->
	
	
	
	</div> <!-- col-md-9/col-md-12 -->


	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2021-06-25 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Android/">Android<span>11</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/tabLayout/">tabLayout<span>1</span></a></li> <li><a href="/tags/viewPager2/">viewPager2<span>1</span></a></li> <li><a href="/tags/fragment/">fragment<span>1</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

		

	</div>
	
		

</div><!-- row -->

<!--
 -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
  &copy; 2024 Weaver Li's Blog
  
      powered by <a href="http://hexo.io/" target="_blank">Hexo</a>.Theme <a href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>  
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
